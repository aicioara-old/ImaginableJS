<html>
<head>
	<meta charset="UTF-8">
	<title>Test Page</title>

	<link rel="stylesheet" href="test.css">

	<script src="jquery.min.js"></script>
	<script src="Imaginable.js"></script>
</head>
<body>


<img src="" alt="Click Me" class="preview-image" id="preview-image">

<input id="input-new-picture" name="new_picture" type="file" style="display: none">

<img src="" alt="" id="final">

<br>

<canvas id="canvas"></canvas>


<br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br>

<form action="server.php" method="POST" enctype="multipart/form-data">
	<input id="mimi" name="new_picture" type="file">
	<button type="button" onclick="mimic()">Press</button>
</form>


<script>


Imaginable.foo();

$("#preview-image").click(function() {
	$("#input-new-picture").click();
});


/**
 * input is an <input> DOM element which can be used to read the image
 */
function loadImage(input, callback) {

	if (!input || !input.files || !input.files[0]) {
		throw Error("No files given");
	}

	if (!input.files[0].type.match(/image.*/)) {
		throw Error("The file selected is not an image");
	};

	var image = input.files[0];

    var reader = new FileReader();
    reader.onload = callback;
    reader.readAsDataURL(image);
}

function drawOnCanvas(img, canvas, finalWidth, finalHeight) {
	finalWidth = finalWidth ? finalWidth : 40;
	finalHeight = finalHeight ? finalHeight : 60;

	if (!canvas) {
		canvas = $("<canvas>", {
			style: "display: none",
		});
		$(document.body).append(canvas);
		canvas = canvas[0];
	}

	var width = img.width;
	var height = img.height;

	if (width > height) {
	  if (width > finalWidth) {
	    height *= finalWidth / width;
	    width = finalWidth;
	  }
	} else {
	  if (height > finalHeight) {
	    width *= finalHeight / height;
	    height = finalHeight;
	  }
	}
	canvas.width = width;
	canvas.height = height;
	var ctx = canvas.getContext("2d");
	ctx.drawImage(img, 0, 0, width, height);

	return canvas;

}

function downloadImage(canvas, fileName) {
	if (!canvas) {
		throw Error("Canvas has to be specified");
	}

	if (!fileName) {
		fileName = "image.png";
	}

	var dataurl = canvas.toDataURL();
	var anchor = $("<a>", {
		href: dataurl,
		download: "file.png",
	}).html("click")[0].click();
}


function sendImageToServer(input, imageName, server, callback) {
	if (!input) {
		throw Error("No arguments given");
	}

	if (!input.files) {
		throw Error("Element given is not a file input")
	}

	if (!input.files[0]) {
		throw Error("No files given");
	}

	if (!input.files[0].type.match(/image.*/)) {
		throw Error("The file selected is not an image");
	};

	if (!imageName) {
		imageName = "new_picture";
	}

	if (!server) {
		throw Error("No server specified");
	}

	var data = new FormData();
	data.append(imageName, input.files[0]);

	jQuery.ajax({
		url: server,
	    type: "POST",
	    data: data,
	    cache: false,
	    contentType: false,
	    processData: false,
	    success: callback,
	});
}

$("#input-new-picture").change(function() {
    loadImage(this, function(image) {
        $('#preview-image').attr('src', image.target.result);
        var canvas = drawOnCanvas($("#preview-image")[0], $("#canvas")[0]);
        downloadImage(canvas);
        sendImageToServer($("#input-new-picture")[0], "new_picture", "server.php");
    });
});


</script>




</body>
</html>